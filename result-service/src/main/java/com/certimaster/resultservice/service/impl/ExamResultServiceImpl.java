package com.certimaster.resultservice.service.impl;

import com.certimaster.common_library.event.AnswerSubmittedEvent;
import com.certimaster.common_library.event.ExamSessionCreatedEvent;
import com.certimaster.common_library.event.ExamSessionStartedEvent;
import com.certimaster.resultservice.entity.UserAnswer;
import com.certimaster.resultservice.entity.UserExamSession;
import com.certimaster.resultservice.repository.UserAnswerRepository;
import com.certimaster.resultservice.repository.UserExamSessionRepository;
import com.certimaster.resultservice.service.ExamResultService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

/**
 * Implementation of ExamResultService.
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class ExamResultServiceImpl implements ExamResultService {

    private final UserExamSessionRepository sessionRepository;
    private final UserAnswerRepository answerRepository;

    @Override
    @Transactional
    public ExamSessionCreatedEvent createSession(ExamSessionStartedEvent event) {
        log.debug("Creating session from event for user {} exam {}", event.getUserId(), event.getExamId());

        try {
            // Check if user already has active session for this exam (idempotency)
            Optional<UserExamSession> existingSession = sessionRepository
                    .findActiveByUserIdAndExamId(event.getUserId(), event.getExamId());
            if (existingSession.isPresent()) {
                log.warn("User {} already has active session {} for exam {}",
                        event.getUserId(), existingSession.get().getId(), event.getExamId());
                return ExamSessionCreatedEvent.builder()
                        .sessionId(existingSession.get().getId())
                        .userId(event.getUserId())
                        .examId(event.getExamId())
                        .success(true)
                        .build();
            }

            // Create session - ID will be generated by database
            UserExamSession session = UserExamSession.builder()
                    .userId(event.getUserId())
                    .examId(event.getExamId())
                    .certificationId(event.getCertificationId())
                    .startTime(event.getStartTime())
                    .status("IN_PROGRESS")
                    .mode(event.getMode())
                    .examTitle(event.getExamTitle())
                    .totalQuestions(event.getTotalQuestions())
                    .durationMinutes(event.getDurationMinutes())
                    .unansweredCount(event.getTotalQuestions())
                    .build();

            session = sessionRepository.save(session);
            log.info("Created session {} for user {} exam {}", session.getId(), event.getUserId(), event.getExamId());

            // Create UserAnswer records for each question
            if (event.getQuestionIds() != null && !event.getQuestionIds().isEmpty()) {
                createUserAnswers(session, event.getQuestionIds());
            }

            return ExamSessionCreatedEvent.builder()
                    .sessionId(session.getId())
                    .userId(event.getUserId())
                    .examId(event.getExamId())
                    .success(true)
                    .build();

        } catch (Exception e) {
            log.error("Failed to create session for user {} exam {}", event.getUserId(), event.getExamId(), e);
            return ExamSessionCreatedEvent.builder()
                    .userId(event.getUserId())
                    .examId(event.getExamId())
                    .success(false)
                    .errorMessage("Failed to create session: " + e.getMessage())
                    .build();
        }
    }

    /**
     * Create UserAnswer records for all questions in the session.
     */
    private void createUserAnswers(UserExamSession session, List<Long> questionIds) {
        List<UserAnswer> answers = new ArrayList<>();

        for (Long questionId : questionIds) {
            UserAnswer answer = UserAnswer.builder()
                    .userExamSession(session)
                    .questionId(questionId)
                    .isFlagged(false)
                    .timeSpentSeconds(0)
                    .build();
            answers.add(answer);
        }

        answerRepository.saveAll(answers);
        log.info("Created {} UserAnswer records for session {}", answers.size(), session.getId());
    }

    @Override
    @Transactional
    public void saveAnswer(AnswerSubmittedEvent event) {
        log.debug("Saving answer for session {} question {}", event.getSessionId(), event.getQuestionId());

        // Find existing answer record
        Optional<UserAnswer> existingAnswer = answerRepository
                .findByUserExamSessionIdAndQuestionId(event.getSessionId(), event.getQuestionId());

        if (existingAnswer.isEmpty()) {
            log.error("UserAnswer not found for session {} question {}", event.getSessionId(), event.getQuestionId());
            return;
        }

        // Update answer
        UserAnswer answer = existingAnswer.get();
        answer.setSelectedOptionIds(event.getSelectedOptionIds().toArray(new Long[0]));
        answer.setIsCorrect(event.getIsCorrect());
        answer.setIsFlagged(event.getIsFlagged());
        answer.setTimeSpentSeconds(event.getTimeSpentSeconds());
        answer.setAnsweredAt(event.getAnsweredAt());

        answerRepository.save(answer);
        log.debug("Updated answer for session {} question {}", event.getSessionId(), event.getQuestionId());

        // Update session statistics
        updateSessionStats(event.getSessionId());
    }

    private void updateSessionStats(Long sessionId) {
        sessionRepository.findById(sessionId).ifPresent(session -> {
            long answeredCount = answerRepository.countByUserExamSessionIdAndSelectedOptionIdsIsNotNull(sessionId);
            long correctCount = answerRepository.countByUserExamSessionIdAndIsCorrectTrue(sessionId);
            long wrongCount = answerRepository.countByUserExamSessionIdAndIsCorrectFalse(sessionId);
            long flaggedCount = answerRepository.countByUserExamSessionIdAndIsFlaggedTrue(sessionId);

            session.setAnsweredCount((int) answeredCount);
            session.setCorrectCount((int) correctCount);
            session.setWrongCount((int) wrongCount);
            session.setFlaggedCount((int) flaggedCount);
            session.setUnansweredCount(session.getTotalQuestions() - (int) answeredCount);

            sessionRepository.save(session);
            log.debug("Updated session {} stats: answered={}, correct={}, wrong={}",
                    sessionId, answeredCount, correctCount, wrongCount);
        });
    }
}
